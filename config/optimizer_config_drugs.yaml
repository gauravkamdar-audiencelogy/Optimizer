# Optimizer Config: drugs.com (HCP Targeting)
# ============================================
# Run: python run_optimizer.py --config config/optimizer_config_drugs.yaml

dataset:
  name: "drugs"  # → data/drugs/, output_drugs/

# -----------------------------------------------------------------------------
# WHAT TO CHANGE REGULARLY
# -----------------------------------------------------------------------------
business:
  target_win_rate: 0.65        # Current target (we're at ~30%)
  exploration_mode: true       # Bid up on losers, down on winners

technical:
  aggressive_exploration: false  # true = faster learning, higher risk
  min_bid_cpm: 3.00
  max_bid_cpm: 20.00           # Overridden by exploration preset below

bidding:
  strategy: "adaptive"         # volume_first | margin_optimize | adaptive

data:
  min_bid_date: "2025-12-10"   # When loss logging started
  min_view_date: "2025-09-15"

# -----------------------------------------------------------------------------
# NPI SETTINGS (drugs.com = HCP targeting = has NPI data)
# -----------------------------------------------------------------------------
npi:
  enabled: true
  data_1year: "data/NPI_click_data_1year.csv"
  data_20day: "data/NPI_click_data_20days.csv"
  max_multiplier: 3.0          # Top NPIs get up to 3x bid
  recency_boost: 1.2           # Recent clickers get +20%

  # Tiering method: 'iqr' (hierarchical IQR - recommended) or 'percentile' (legacy)
  tiering_method: iqr

  # --- IQR PARAMETERS (used when tiering_method='iqr') ---
  iqr_multiplier_stars: 1.5    # Elite threshold = Q3 + 1.5×IQR
  iqr_multiplier_extreme: 3.0  # Extreme threshold = Q3 + 3.0×IQR
  poor_rate_factor: 0.3        # Poor threshold = 30th percentile of clicks

  # 5-tier multipliers for IQR method (higher than domain due to direct NPI value)
  multiplier_extreme_elite: 3.00  # > Q3 + 3.0×IQR (capped at max_multiplier)
  multiplier_elite: 2.50          # > Q3 + 1.5×IQR
  multiplier_cream: 1.80          # > Middle_Q3 + 1.5×Middle_IQR
  multiplier_baseline: 1.00       # > poor_threshold
  multiplier_poor: 0.70           # ≤ poor_threshold

  # Observation threshold for IQR tiering
  min_clicks_for_tiering: 5

# -----------------------------------------------------------------------------
# DOMAIN OPTIMIZATION (disabled for drugs.com - single domain)
# -----------------------------------------------------------------------------
domain:
  enabled: false  # drugs.com is single domain, no domain optimization needed

# -----------------------------------------------------------------------------
# EXPLORATION PRESETS (selected by aggressive_exploration toggle)
# -----------------------------------------------------------------------------
exploration_presets:
  aggressive:
    bonus_zero_obs: 0.50       # +50% for unknown segments
    bonus_low_obs: 0.35        # +35% for 1-9 observations
    bonus_medium_obs: 0.15     # +15% for 10-49 observations
    max_adjustment: 1.8
    max_bid_cpm: 30.00

  gradual:
    bonus_zero_obs: 0.25
    bonus_low_obs: 0.15
    bonus_medium_obs: 0.08
    max_adjustment: 1.4
    max_bid_cpm: 20.00

# -----------------------------------------------------------------------------
# FEATURES (algorithm auto-selects best 3 from candidates)
# -----------------------------------------------------------------------------
features:
  anchor: [internal_adspace_id]

  candidates:
    - internal_adspace_id
    - geo_region_name
    - geo_country_code2
    - os_code
    - domain
    - browser_code
    - hour_of_day
    - day_of_week
    - media_type

  exclude:
    - geo_postal_code          # Too sparse
    - geo_city_name            # Too sparse
    - pageurl_truncated        # Creates 78K+ segments (OOM)
    - log_txnid                # Join key
    - internal_txn_id          # Join key
    - log_dt                   # Timestamp

# -----------------------------------------------------------------------------
# ADVANCED (rarely need to change)
# -----------------------------------------------------------------------------
advanced:
  # Observation thresholds
  min_observations: 1                    # Include all segments
  min_observations_for_empirical: 10     # Use empirical model at 10+ obs
  min_observations_for_landscape: 50     # Use bid landscape at 50+ obs

  # Adaptive strategy thresholds
  min_win_rate_for_margin: 0.55
  min_observations_for_margin: 100

  # Model settings
  shrinkage_k: 30
  calibration_ece_threshold: 0.10

  # Feature selection thresholds
  min_signal_score: 50.0
  max_features: 3

  # Other
  default_bid_cpm: 12.50
  floor_available: false
  target_margin: 0.30

# -----------------------------------------------------------------------------
# VALIDATION (checks before deployment)
# -----------------------------------------------------------------------------
validation:
  enabled: true                          # Set to false to skip validation

  # Hard guardrails (block deployment if violated)
  hard_rules:
    coverage_min_pct: 80.0               # Min % segments vs previous run
    calibration_ece_max: 0.15            # Max ECE for used models
    bid_floor_respected: true            # All bids >= min_bid
    bid_ceiling_respected: true          # All bids <= max_bid

  # Soft guardrails (warn but allow)
  soft_rules:
    bid_median_change_max_pct: 50.0      # Max % change vs previous
    pct_at_floor_max: 30.0               # Max % bids at floor
    pct_at_ceiling_max: 30.0             # Max % bids at ceiling
    pct_profitable_min: 40.0             # Min % profitable segments

  # Optional: path to previous run's metrics.json for comparison
  previous_run_path: null
