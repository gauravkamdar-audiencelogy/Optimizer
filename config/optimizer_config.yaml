# V5 Configuration: Volume-First Optimizer with Asymmetric Exploration
# optimizer_config.yaml
#
# V5 Philosophy:
# - Priority is DATA COLLECTION, not margin optimization
# - Losing segments → Bid HIGHER to learn ceiling
# - Winning segments → Bid LOWER to find floor
# - Target: 65% win rate to learn the full bid landscape
# - Include ALL segments (no min_observations filter)
#
# V5 Changes from V4:
# - New exploration_mode for asymmetric bid adjustment
# - Accept negative margins during data collection
# - NPI value integration
# - Include ALL segments (remove min_observations filter effect)
# - Wider adjustment bounds [0.6, 1.8]

# ============================================================================
# BUSINESS CONTROLS (V5)
# ============================================================================
business:
  # Target margin (bid shading) - used as fallback
  target_margin: 0.30

  # V5: Higher target win rate for volume (was 0.50)
  target_win_rate: 0.65

  # Win rate sensitivity (for non-exploration mode)
  win_rate_sensitivity: 0.5

  # V5: Exploration mode - asymmetric bid adjustment
  exploration_mode: true

  # V5: Asymmetric exploration multipliers
  # Under-winning (WR < target) → bid UP
  # Over-winning (WR > target) → bid DOWN
  exploration_up_multiplier: 1.3    # Aggressive on losers
  exploration_down_multiplier: 0.7  # Cautious on winners

  # V5: Accept negative margin during learning phase
  accept_negative_margin: true
  max_negative_margin_pct: 0.50  # Cap at 50% overpay (bid up to 1.5x EV)

  # V5: NPI integration (click data based)
  use_npi_value: true
  npi_1year_path: "data_drugs/NPI_click_data_1year.csv"   # Historical RPU
  npi_20day_path: "data_drugs/NPI_click_data_20days.csv"  # Recency signal
  npi_max_multiplier: 3.0    # Max multiplier for top NPIs
  npi_recency_boost: 1.2     # +20% boost for recent clickers

# ============================================================================
# TECHNICAL CONTROLS (V5)
# ============================================================================
technical:
  # Bid price bounds (CPM)
  min_bid_cpm: 3.00
  max_bid_cpm: 30.00
  default_bid_cpm: 12.50  # V5: Raised for exploration baseline (was 5.00)

  # Floor price handling (Phase 1: no floor available)
  floor_available: false

  # V5: Tiered observation thresholds (instead of binary filter)
  min_observations: 1              # V5: Include ALL segments (was 100!)
  min_observations_for_empirical: 10   # Use empirical WR with 10+ obs
  min_observations_for_landscape: 50   # Use landscape model with 50+ obs

  # Feature selection
  max_features: 3

  # Model shrinkage
  ctr_shrinkage_k: 30
  win_rate_shrinkage_k: 30

  # Soft exclusion thresholds (algorithm uses these to auto-exclude)
  min_signal_score: 50.0
  min_coverage_at_threshold: 0.5
  max_null_pct: 30.0

  # Effective cardinality filter (prevents dominated features)
  min_effective_cardinality: 2
  effective_cardinality_min_share: 0.05

  # V5: WIDER adjustment bounds for exploration
  min_win_rate_adjustment: 0.6   # V5: Lowered (was 0.8)
  max_win_rate_adjustment: 1.8   # V5: Raised (was 1.2)

  # V5: Exploration bonuses for sparse segments
  exploration_bonus_zero_obs: 0.50   # +50% for unknown segments
  exploration_bonus_low_obs: 0.35    # +35% for 1-9 observations
  exploration_bonus_medium_obs: 0.15 # +15% for 10-49 observations

# ============================================================================
# FEATURE CONFIGURATION (V5)
# ============================================================================
features:
  # Anchor features - always included
  anchor_features:
    - internal_adspace_id

  # Candidate features - let algorithm decide
  candidate_features:
    - internal_adspace_id
    - geo_region_name
    - geo_country_code2
    - os_code
    - pageurl_truncated
    - domain
    - browser_code
    - hour_of_day
    - day_of_week
    - media_type
    - make_id
    - model_id
    - carrier_code

  # V5: HARD exclusions only - technical/structural reasons
  # NOTE: external_userid REMOVED - now used for NPI lookup
  hard_exclude_features:
    - geo_postal_code      # Too sparse (7,027 unique)
    - geo_city_name        # Too sparse (3,333 unique)
    - log_txnid            # Technical: join key
    - internal_txn_id      # Technical: join key
    - log_dt               # Technical: timestamp
    - pageurl_truncated    # Too sparse (creates 78K+ segments, OOM issues)

# ============================================================================
# DATA CONFIGURATION
# ============================================================================
data:
  min_bid_date: "2025-12-10"
  min_view_date: "2025-09-15"
  remove_zero_bids: true
  deduplicate_views: true
