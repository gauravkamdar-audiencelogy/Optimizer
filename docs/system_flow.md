┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                             │
│                                          ┌─────────────┐                                                    │
│                                          │  SNOWFLAKE  │                                                    │
│                                          │   (Source)  │                                                    │
│                                          └──────┬──────┘                                                    │
│                                                 │                                                           │
│                                                 │ 3 Data Files Extracted                                    │ 
│                                                 ▼                                                           │
│     ┌─────────────┐                    ┌───────────────────────────────┐                    ┌─────────────┐ │
│     │             │  2 Config Read     │         OPTIMIZER             │  7 Output Files    │             │ │
│     │    MySQL    │ ──────────────────▶│    ┌─────┐  ┌─────┐  ┌─────┐  │───────────────────▶│     S3      │ │
│     │  (Config &  │                    │    │Load │─▶│Proc │─▶│Model│  │     Dumped         │  (Storage)  │ │
│     │   Audit)    │                    │    │Data │  │ess  │  │s    │  │                    │             │ │
│     │             │  8 Features        │    └─────┘  └─────┘  └──┬──┘  │                    └──────┬──────┘ │
│     │             │◀───Recorded────────│                         ▼     │                           │        │
│     └─────────────┘                    │  ┌────────────────────────┐   │                           │        │
│            ▲                           │  │    OUTPUT FILES        │   │                           │        │
│            │                           │  │ • suggested_bids.csv   │   │               ┌───────────┘        │
│            │ 1a Config                 │  │ • domain_mult.csv      │   │               │ 9 Memcache         │
│            │   Logged                  │  │ • npi_mult.csv         │   │               │   Files            │
│            │                           │  │ • metrics.json         │   │               │                    │
│     ┌──────┴──────┐                    │  └────────────────────────┘   │               ▼                    │
│     │             │                    └───────────────────────────────┘       ┌─────────────┐              │
│     │     UI      │                             ▲                              │             │              │
│     │  (Input)    │     1b Trigger Run          |                              │   BIDDER    │──────────────|───▶ 
│     │             │─────────────────────────────┘                              │  (Memcache) │  10 Bids     │
│     └──────┬──────┘                                                            │             │    Sent      │
│            ▲                                                                   └─────────────┘              │
│            │                                                                                                │
│     ┌──────┴──────┐                                                                                         │
│     │    USER     │                                                                                         │
│     └─────────────┘                                                                                         │
│                                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘





┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                             │
│   STEP 1: USER TRIGGERS RUN                                                                                │
│   ═══════════════════════════                                                                              │
│                                                                                                             │
│        ┌─────────┐         ┌─────────────────────────────────────────────┐         ┌─────────────┐         │
│        │         │         │                    UI                       │         │             │         │
│        │  USER   │────────▶│  • Select entity (drugs.com)                │────────▶│   MySQL     │         │
│        │         │ Clicks  │  • Adjust configs (win_rate, margin)        │  INSERT │             │         │
│        └─────────┘ "Run"   │  • Click "Run Optimizer"                    │         │  opt_runs   │         │
│                            └─────────────────────────────────────────────┘         │  status=    │         │
│                                                                                    │  'queued'   │         │
│                                                                                    └─────────────┘         │
│                                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                             │
│   STEP 2: OPTIMIZER READS CONFIG                                                                           │
│   ══════════════════════════════                                                                           │
│                                                                                                             │
│        ┌─────────────┐                              ┌─────────────────────────────────────────────┐         │
│        │             │         SELECT               │                                             │         │
│        │   MySQL     │─────────────────────────────▶│               OPTIMIZER                     │         │
│        │             │    SELECT config_key,        │                                             │         │
│        │  opt_runs + │    config_value              │   config = {                                │         │
│        │  opt_run_   │    FROM opt_run_configs      │     "target_win_rate": 0.65,               │         │
│        │  configs    │    WHERE run_id = ?          │     "max_bid": 30.00,                      │         │
│        └─────────────┘                              │     ...                                     │         │
│                                                     │   }                                         │         │
│                                                     └─────────────────────────────────────────────┘         │
│                                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                             │
│   STEP 3: DATA EXTRACTION                                                                                  │
│   ═══════════════════════                                                                                  │
│                                                                                                             │
│        ┌─────────────┐                              ┌─────────────────────────────────────────────┐         │
│        │             │                              │                                             │         │
│        │  SNOWFLAKE  │─────────────────────────────▶│               OPTIMIZER                     │         │
│        │             │      bid_data.csv            │                                             │         │
│        │  TN_PROD.   │      view_data.csv           │   Downloads to local:                       │         │
│        │  ANALYTICS  │      click_data.csv          │   data_drugs/raw/                           │         │
│        │             │                              │                                             │         │
│        └─────────────┘                              └─────────────────────────────────────────────┘         │
│                                                                                                             │
│        Query: SELECT * FROM bid_events WHERE log_dt BETWEEN '2025-09-15' AND '2026-01-28'                  │
│                                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                             │
│   STEP 4-6: OPTIMIZER PIPELINE                                                                             │
│   ════════════════════════════                                                                             │
│                                                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                    OPTIMIZER INTERNAL FLOW                                          │  │
│   │                                                                                                     │  │
│   │  ┌────────────────┐    ┌────────────────┐    ┌────────────────┐    ┌────────────────┐              │  │
│   │  │                │    │                │    │                │    │                │              │  │
│   │  │  DATA LOADER   │───▶│   FEATURE      │───▶│    MODELS      │───▶│  BID CALC      │              │  │
│   │  │                │    │   SELECTOR     │    │                │    │                │              │  │
│   │  └────────────────┘    └────────────────┘    └────────────────┘    └────────────────┘              │  │
│   │         │                     │                     │                     │                        │  │
│   │         ▼                     ▼                     ▼                     ▼                        │  │
│   │  ┌────────────────┐    ┌────────────────┐    ┌────────────────┐    ┌────────────────┐              │  │
│   │  │ • Load CSVs    │    │ • Score each   │    │ • CTR Model    │    │ • EV = CTR×CPC │              │  │
│   │  │ • Join bid→view│    │   feature      │    │   (calibrated) │    │ • Bid = EV ×   │              │  │
│   │  │ • Filter dates │    │ • Select top 3 │    │ • Win Rate     │    │   (1-margin) × │              │  │
│   │  │ • Clean data   │    │ • Auto-exclude │    │   Model        │    │   WR_adjust    │              │  │
│   │  │                │    │   low signal   │    │                │    │ • Apply NPI    │              │  │
│   │  └────────────────┘    └────────────────┘    └────────────────┘    └────────────────┘              │  │
│   │                                                                                                     │  │
│   │         STEP 4                STEP 5                STEP 5               STEP 6                    │  │
│   │      Data Loading         Feature Selection      Model Training       Bid Calculation              │  │
│   │                                                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                             │
│   STEP 7: OUTPUT FILES GENERATED                                                                           │
│   ══════════════════════════════                                                                           │
│                                                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                       OUTPUT FILES                                                  │  │
│   │                                                                                                     │  │
│   │    ┌──────────────────────────────┐         ┌──────────────────────────────┐                       │  │
│   │    │                              │         │                              │                       │  │
│   │    │   memcache_20260128.csv      │         │   metrics_20260128.json      │                       │  │
│   │    │                              │         │                              │                       │  │
│   │    │   internal_adspace_id  \t    │         │   {                          │                       │  │
│   │    │   geo_region_name      \t    │         │     "run_info": {...},       │                       │  │
│   │    │   os_code              \t    │         │     "data_stats": {...},     │                       │  │
│   │    │   suggested_bid_cpm          │         │     "feature_selection": {   │                       │  │
│   │    │   ─────────────────────      │         │       "selected": [...]      │                       │  │
│   │    │   111563  California  8  19.2│         │     },                        │                       │  │
│   │    │   111563  Texas       8  18.5│         │     "model_performance": {}  │                       │  │
│   │    │   111564  California  14 20.0│         │   }                          │                       │  │
│   │    │   ...                        │         │                              │                       │  │
│   │    │   (93 segments)              │         │                              │                       │  │
│   │    │                              │         │                              │                       │  │
│   │    └──────────────────────────────┘         └──────────────────────────────┘                       │  │
│   │                                                                                                     │  │
│   │    ┌──────────────────────────────┐         ┌──────────────────────────────┐                       │  │
│   │    │                              │         │                              │                       │  │
│   │    │   npi_multipliers.csv        │         │   segment_analysis.csv       │                       │  │
│   │    │                              │         │                              │                       │  │
│   │    │   external_userid,multiplier │         │   Full segment details       │                       │  │
│   │    │   1234567890,2.5             │         │   with CTR, win_rate, EV     │                       │  │
│   │    │   9876543210,1.0             │         │                              │                       │  │
│   │    │   (64,783 NPIs)              │         │                              │                       │  │
│   │    │                              │         │                              │                       │  │
│   │    └──────────────────────────────┘         └──────────────────────────────┘                       │  │
│   │                                                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                             │
│   STEP 8: S3 UPLOAD + MySQL UPDATE                                                                         │
│   ════════════════════════════════                                                                         │
│                                                                                                             │
│        ┌─────────────────────────────────────────────┐                                                     │
│        │               OPTIMIZER                      │                                                     │
│        └──────────────────┬──────────────────────────┘                                                     │
│                           │                                                                                 │
│              ┌────────────┴────────────┐                                                                   │
│              │                         │                                                                   │
│              ▼                         ▼                                                                   │
│   ┌─────────────────────┐   ┌─────────────────────┐                                                       │
│   │                     │   │                     │                                                       │
│   │         S3          │   │       MySQL         │                                                       │
│   │                     │   │                     │                                                       │
│   │  s3://tn-optimizer- │   │  UPDATE opt_runs   │                                                       │
│   │  data/drugs_com/v3/ │   │  SET status =      │                                                       │
│   │  20260128_090000/   │   │    'completed',    │                                                       │
│   │    ├── memcache.csv │   │    features_used = │                                                       │
│   │    ├── metrics.json │   │    'geo,os,browser'│                                                       │
│   │    ├── npi.csv      │   │    segments_count, │                                                       │
│   │    └── analysis.csv │   │    domains_count,  │                                                       │
│   │                     │   │    completed_at    │                                                       │
│   │                     │   │                    │                                                       │
│   │                     │   │  INSERT INTO       │                                                       │
│   │                     │   │  opt_run_metrics   │                                                       │
│   └─────────────────────┘   └─────────────────────┘                                                       │
│                                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                             │
│   STEP 9-10: BIDDER LOADS & SERVES                                                                         │
│   ════════════════════════════════                                                                         │
│                                                                                                             │
│   ┌─────────────────┐      ┌─────────────────┐      ┌─────────────────────────────────────────────────┐   │
│   │                 │      │                 │      │                                                 │   │
│   │      MySQL      │      │       S3        │      │                    BIDDER                       │   │
│   │                 │      │                 │      │                                                 │   │
│   │  opt_deployments│      │  memcache.csv   │      │  ┌─────────────────────────────────────────┐   │   │
│   │  (active runs)  │─────▶│  npi.csv        │─────▶│  │              MEMCACHE                   │   │   │
│   │                 │      │                 │      │  │                                         │   │   │
│   │  opt_feature_   │      │                 │      │  │  Key: [ADX_PLACEMENT]|[GEO]|[OS]       │   │   │
│   │  macros         │      │                 │      │  │  Value: suggested_bid_cpm              │   │   │
│   │                 │      │                 │      │  │                                         │   │   │
│   │  Macro format:  │      │                 │      │  │  "111563|California|8" → 19.20         │   │   │
│   │  [ADX_PLACEMENT]│      │                 │      │  │  "111563|Texas|8" → 18.50              │   │   │
│   │  |[ADX_GEO]     │      │                 │      │  │                                         │   │   │
│   │  |[ADX_OS]      │      │                 │      │  │  NPI lookup:                            │   │   │
│   │                 │      │                 │      │  │  "1234567890" → 2.5x multiplier        │   │   │
│   │                 │      │                 │      │  │                                         │   │   │
│   └─────────────────┘      └─────────────────┘      │  └─────────────────────────────────────────┘   │   │
│                                                      │                                                 │   │
│                                                      │                       │                         │   │
│                                                      │                       ▼                         │   │
│                                                      │                                                 │   │
│                                                      │  ┌─────────────────────────────────────────┐   │   │
│                                                      │  │           BID REQUEST                   │   │   │
│                                                      │  │                                         │   │   │
│                                                      │  │   placement=111563                      │   │   │
│                                                      │  │   geo=California                        │   │   │
│                                                      │  │   os=8 (iOS)                            │   │   │
│                                                      │  │   npi=1234567890                        │   │   │
│                                                      │  │                                         │   │   │
│                                                      │  │   Lookup: $19.20 × 2.5 = $48.00 CPM    │   │   │
│                                                      │  │                                         │   │   │
│                                                      │  └─────────────────────────────────────────┘   │   │
│                                                      │                                                 │   │
│                                                      └────────────────────────┬────────────────────────┘   │
│                                                                               │                             │
│                                                                               │                             │
│                                                                               ▼                             │
│                                                                    ┌───────────────────┐                   │
│                                                                    │                   │                   │
│                                                                    │   BID RESPONSE    │                   │
│                                                                    │                   │                   │
│                                                                    │   bid: $48.00 CPM │──────────────▶   │
│                                                                    │   to SSP auction  │    TO EXCHANGE    │
│                                                                    │                   │                   │
│                                                                    └───────────────────┘                   │
│                                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘